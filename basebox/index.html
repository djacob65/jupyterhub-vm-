


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Building automation of a virtual machine (VM) from a server install image of ubuntu (ISO file)">
      
      
      
        <meta name="author" content="Daniel Jacob">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-5.2.2">
    
    
      
        <title>Base Box</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b8fb47b5.min.css">
      
      
    
    
    
    <script src="../js/jquery-2.1.1.min.js"></script>

    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/pdfextra.css">
    
      <link rel="stylesheet" href="../css/lightbox.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-the-base-vm-base-box-for-vagrant" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-header-nav__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Using JupyterHub within a VM and on the Cloud
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Base Box
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-nav__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Using JupyterHub within a VM and on the Cloud
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Purpose" class="md-nav__link">
      Purpose
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Building the Base VM
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Building the Base VM" class="md-nav__link md-nav__link--active">
      Building the Base VM
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-the-base-vm-base-box-for-vagrant" class="md-nav__link">
    Building the base VM (Base box) for Vagrant
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-base-vm" class="md-nav__link">
    Creating the base VM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registering-a-box-on-vagrant-cloud" class="md-nav__link">
    Registering a box on Vagrant Cloud
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../finalvm/" title="Building the Final VM" class="md-nav__link">
      Building the Final VM
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cloud/" title="Using the Final VM on an Openstack cloud" class="md-nav__link">
      Using the Final VM on an Openstack cloud
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../google-cloud/" title="Using the Final VM on Google Cloud Platform" class="md-nav__link">
      Using the Final VM on Google Cloud Platform
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-the-base-vm-base-box-for-vagrant" class="md-nav__link">
    Building the base VM (Base box) for Vagrant
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-base-vm" class="md-nav__link">
    Creating the base VM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registering-a-box-on-vagrant-cloud" class="md-nav__link">
    Registering a box on Vagrant Cloud
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Building the Base VM</h1>
                
                <h4 id="building-the-base-vm-base-box-for-vagrant">Building the base VM (Base box) for Vagrant<a class="headerlink" href="#building-the-base-vm-base-box-for-vagrant" title="Permanent link">&para;</a></h4>
<p>It is assumed that you have installed the <a href="https://www.packer.io/downloads" target="_blank">Packer</a> and <a href="https://www.vagrantup.com/downloads" target="_blank">Vagrant tools</a>, as well as the <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank">Oracle VirtualBox</a> virtualisation software.</p>
<p>The operations for creating a base box are documented online; you have to follow the <a href="http://docs.vagrantup.com/v2/boxes/base.html" target="_blank">basic guide</a> and apply the provider-specific rules, namely for <a href="http://docs.vagrantup.com/v2/virtualbox/boxes.html" target="_blank">VirtualBox</a> . The procedure is somewhat tedious and, above all, an error can happen quickly. This is why we will use the Packer tool, which allows to fully automate the creation of a Vagrant base box by following the process illustrated by the figure below:</p>
<p><br>
<center>
<a href="../images/image1.png" data-lightbox="image1"><img src="../images/image1.png" width="600px"></a>
</center><br><br></p>
<p><strong>Note</strong>: All the scripts and other configuration files mentioned in this description can be found in free access under the <a href="https://github.com/inrae/jupyterhub-vm" target="_blank">GiHub INRAE repository</a>.</p>
<p>We are using <a href="http://cdimage.ubuntu.com/ubuntu/releases/18.04/release/" target="_blank">Ubuntu version 18.04</a> as a basis.</p>
<p>A Packer configuration is defined with a JSON file (box-config.json) with several sections: </p>
<ul>
<li>"builders": is used to define the elements for creating the virtual machine from an ISO image.</li>
<li>"provisioners": is used to define the software configuration from Shell scripts to provision the virtual machine.</li>
<li>"post-processors": runs once the virtual machine is created and provisioned. This allows among other things to define the output format of the VM.</li>
</ul>
<p><strong>"builders" section</strong></p>
<ul>
<li>To build this section, it is often simpler to start from already functional examples and to modify the few elements specific to its configuration. A query in a search engine (e.g. Google) with the keywords "github packer ubuntu 18.04 virtualbox" will give you enough examples. So we started with <a href="https://github.com/geerlingguy/packer-boxes/tree/master/ubuntu1804" target="_blank">an example appropriate to our needs</a>, which we then adapted.</li>
<li>The VirtualBox box is made from an Ubuntu ISO specified by its URL (iso_urls) in order to create the VM in VirtualBox ("type": "virtualbox-iso") .</li>
<li>A "preseed" file (http/preseed.cfg) allows to configure the installation (see more info on <a href="https://help.ubuntu.com/18.04/installation-guide/amd64/apb.html" target="_blank">preseeding</a> ). We have adapted the example by adding instructions concerning the root account and the network configuration.</li>
<li>We limited the maximum disk size to 18GB ("disk_size": 18432) so that the final VM can be accepted by the <a href="https://www.genouest.org/tag/cloud/" target="_blank">Genouest cloud</a>.</li>
</ul>
<p><strong>"provisioners" section</strong></p>
<p>This section allows to run Shell scripts after the virtual machine has booted properly and then its operating system installed. So it is in this step that we can configure the VM to be compatible with Vagrant and VirtualBox. A Shell script (scripts/setup.sh) is then executed in order to:</p>
<ul>
<li>install the drivers for VirtualBox</li>
<li>configure SSH accesses in compliance with Vagrant boxes. </li>
</ul>
<p><strong>"post-processors" section</strong></p>
<ul>
<li>Once the base virtual machine is fully installed and configured, it is simply exported to Vagrant format. </li>
</ul>
<h4 id="creating-the-base-vm">Creating the base VM<a class="headerlink" href="#creating-the-base-vm" title="Permanent link">&para;</a></h4>
<p>Once the configuration has been established, simply run Packer as follows:</p>
<div class="highlight"><pre><span></span><code>$&gt; packer build box-config.json
</code></pre></div>

<p>All the messages produced can be consulted on the <a href="https://github.com/inrae/jupyterhub-vm/blob/master/logs/packer.log" target="_blank">github repository</a>. The base VM after execution can be found under the builds directory.</p>
<p><br><br></p>
<h4 id="registering-a-box-on-vagrant-cloud">Registering a box on Vagrant Cloud<a class="headerlink" href="#registering-a-box-on-vagrant-cloud" title="Permanent link">&para;</a></h4>
<p>Vagrant Cloud provides an API that allows users to register their virtual machines (boxes) with Vagrant Cloud so that they can be reused by themselves or by other users.  The use of the <a href="https://www.vagrantup.com/docs/cli/cloud" target="_blank">API is described online</a>. </p>
<p>The registration of a virtual machine can only be done with the Vagrant format, i.e. a "box". A "box" is in fact a zipped archive file (TAR + GZIP) with the extension '.box'.
Registering a "box" consists of 5 steps:</p>
<ol>
<li>Creating an entry for the "box": at least the name of the box (boxname) must be specified. Its description is optional.</li>
<li>Creating a version: there may be several versions of the same entry; the version must be specified.</li>
<li>Creation of a provider: similarly, for an entry (boxname) and a version, there may be several associated providers; the provider must be specified.</li>
<li>Upload the box file.</li>
<li>Validate the box. (entry + version + provider)</li>
</ol>
<p>All of these steps can be done either via the Vagrant Cloud web interface, or through multiple API calls. In order to facilitate the automation of registrations, the Vagrant tool provides a 'cloud' functionality that allows you to register your box on Vagrant Cloud. This requires an account (called an 'organisation') to be created on Vagrant Cloud. </p>
<p>Example of invocation : </p>
<p><div class="highlight"><pre><span></span><code>$&gt; vagrant cloud auth login
</code></pre></div>
<div class="highlight"><pre><span></span><code> ...
Vagrant Cloud username: GAEV
Vagrant Cloud password: XXXXXXX
</code></pre></div></p>
<p><div class="highlight"><pre><span></span><code>$&gt; vagrant cloud publish GAEV/centos7-dd8Gb 1.0.0 virtualbox virtualbox-centos7_8Gb.box 
</code></pre></div>
<div class="highlight"><pre><span></span><code>You are about to create a box on Vagrant Cloud with the following options:
GAEV/centos7-dd8Gb (1.0.0) for virtualbox
Automatic Release:     true
Do you wish to continue? [y/N] y
Creating a box entry...
Creating a version entry...
Creating a provider entry...
Uploading provider with file /Vagrant/boxes/virtualbox-centos7_8Gb.box
Releasing box...
Complete!
tag:                  GAEV/centos7-dd8Gb
username:             GAEV
name:                 centos7-dd8Gb
private:              false
downloads:            0
created_at:           2020-07-25T17:53:04.340Z
updated_at:           2020-07-25T18:01:10.665Z
current_version:      1.0.0
providers:            virtualbox
</code></pre></div></p>
<p>The registered box can be viewed on <a href="https://app.vagrantup.com/GAEV/boxes/centos7-dd8Gb" target="_blank">Vagrant Cloud</a>.</p>
<p><br><br><br></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href=".." title="Purpose" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Purpose
              </div>
            </div>
          </a>
        
        
          <a href="../finalvm/" title="Building the Final VM" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Building the Final VM
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Daniel Jacob, INRAE, 2021
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.de50e36d.min.js"></script>
      <script src="../assets/javascripts/bundle.ff925e8b.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../js/lightbox.min.js"></script>
      
        <script src="../js/mermaid.min.js"></script>
      
    
  </body>
</html>