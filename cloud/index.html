


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Building automation of a virtual machine (VM) from a server install image of ubuntu (ISO file)">
      
      
      
        <meta name="author" content="Daniel Jacob">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.2.2">
    
    
      
        <title>Openstack Cloud</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b8fb47b5.min.css">
      
      
    
    
    
    <script src="../js/jquery-2.1.1.min.js"></script>

    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/pdfextra.css">
    
      <link rel="stylesheet" href="../css/lightbox.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#retrieving-its-connection-settings-from-genouest-openstack" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-header-nav__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Using JupyterHub within a VM and on the Cloud
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Openstack Cloud
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-nav__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Using JupyterHub within a VM and on the Cloud
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Purpose" class="md-nav__link">
      Purpose
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../basebox/" title="Building the Base VM" class="md-nav__link">
      Building the Base VM
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../finalvm/" title="Building the Final VM" class="md-nav__link">
      Building the Final VM
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Using the final VM on an Openstack cloud
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Using the final VM on an Openstack cloud" class="md-nav__link md-nav__link--active">
      Using the final VM on an Openstack cloud
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#retrieving-its-connection-settings-from-genouest-openstack" class="md-nav__link">
    Retrieving its connection settings from GenOuest Openstack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-image-on-the-openstack-infrastructure" class="md-nav__link">
    Creating the image on the openstack infrastructure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-an-instance-from-the-created-image" class="md-nav__link">
    Creating an instance from the created image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    Acknowledgements
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#retrieving-its-connection-settings-from-genouest-openstack" class="md-nav__link">
    Retrieving its connection settings from GenOuest Openstack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-image-on-the-openstack-infrastructure" class="md-nav__link">
    Creating the image on the openstack infrastructure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-an-instance-from-the-created-image" class="md-nav__link">
    Creating an instance from the created image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    Acknowledgements
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Using the final VM on an Openstack cloud</h1>
                
                <p><a href="https://www.genouest.org/" target="_blank">GenOuest</a> is a national bioinformatics platform federated by the <a href="https://www.france-bioinformatique.fr/" target="_blank">French Institute of Bioinformatics</a> (IFB). This platform offers cloud services for the French public research community. Any researcher from this community can make a request to Genouest or any other IFB platform to have access to the proposed services.</p>
<p>GenOuest offers on its datacenter infrastructure a service of providing computing resources in the form of virtual machines. The infrastructure is managed using <a href="https://www.openstack.org/" target="_blank">Openstack</a>, which is a set of open source software that allows the deployment of cloud computing infrastructures (Infrastructure as a Service, IaS). It is therefore necessary to have a valid account on this infrastructure (see the <a href="https://help.genouest.org/" target="_blank">online help</a>).</p>
<p>It is then assumed that you have installed Python (≥2.7) as well as the <a href="https://docs.openstack.org/newton/user-guide/common/cli-install-openstack-command-line-clients.html" target="_blank">package python-openstackclient</a> . </p>
<h4 id="retrieving-its-connection-settings-from-genouest-openstack">Retrieving its connection settings from GenOuest Openstack<a class="headerlink" href="#retrieving-its-connection-settings-from-genouest-openstack" title="Permanent link">&para;</a></h4>
<p>To set the required environment variables for openstack command line clients, you must download the environment file called openrc.sh from the <a href="https://www.youtube.com/embed/XcQYz--CNiM?ab_channel=UKCloudLtd" target="_blank">GenOuest openStack dashboard</a> as a user. This project-specific environment file contains the credentials that all openstack services use.</p>
<p><br>
<center>
<a href="../images/image3.png" data-lightbox="image3"><img src="../images/image3.png" width="600px"></a>
</center><br><br></p>
<p><strong>Note</strong>: All the scripts and other configuration files mentioned in this description can be found in free access under the <a href="https://github.com/inrae/jupyterhub-vm/tree/master/openstack" target="_blank">GiHub INRAE repository</a>.</p>
<p>You need to get the <em>openrc.sh</em> script as well as the <em>cloud.yml</em> configuration file. The latter is to be put in the <em>&lt;home directory>/.config/openstack</em> directory.</p>
<p>Then run the <em>openrc.sh</em> script in the current shell (i.e invoking using a dot); you will be asked for your password:</p>
<div class="highlight"><pre><span></span><code>$&gt; . ./openrc.sh
Please enter your OpenStack Password for project &lt;Project&gt; as user &lt;Users&gt;:
</code></pre></div>

<ul>
<li><em>&lt;Project></em> and <em>&lt;User></em> corresponding to your configuration.</li>
</ul>
<p>We will define some aliases to simplify the following commands:</p>
<div class="highlight"><pre><span></span><code>OS_SCRIPTS=&lt;path of the python-openstackclient scripts&gt;

alias ostack=&quot;$OS_SCRIPTS/openstack --os-cloud=openstack --os-password $OS_PASSWORD&quot;
alias onova=&quot;$OS_SCRIPTS/nova --os-password $OS_PASSWORD&quot;
</code></pre></div>

<p>If everything is configured correctly, the following command should provide you with a list of available flavors. Flavours define the hardware configuration available for a server. It defines the size of a virtual server that can be started.</p>
<p><div class="highlight"><pre><span></span><code>$&gt; ostack flavor list
</code></pre></div>
<div class="highlight"><pre><span></span><code>+------------+-------+------+-------+-----------+
 | Name       |   RAM | Disk | VCPUs | Is Public |
 +------------+-------+------+-------+-----------+
 | m2.xlarge  | 16384 |   20 |     4 | True      |
 | m1.small   |  2048 |   20 |     1 | True      |
 | m2.large   |  8192 |   20 |     2 | True      |
 | m1.medium  |  4096 |   20 |     2 | True      |
 | m2.4xlarge | 65536 |   20 |     8 | True      |
 | m2.medium  |  4096 |   20 |     1 | True      |
 | m1.2xlarge | 32768 |   20 |     8 | True      |
 | m1.large   |  8192 |   20 |     4 | True      |
 | m1.xlarge  | 16384 |   20 |     8 | True      |
 | m2.2xlarge | 32768 |   20 |     4 | True      |
 +------------+-------+------+-------+-----------+
</code></pre></div></p>
<p>We will then proceed in two steps:</p>
<ol>
<li>create a VM image within the library</li>
<li>create an instance of this image</li>
</ol>
<p><br>
<center>
<a href="../images/image4.png" data-lightbox="image4"><img src="../images/image4.png" width="600px"></a>
</center><br><br></p>
<h4 id="creating-the-image-on-the-openstack-infrastructure">Creating the image on the openstack infrastructure<a class="headerlink" href="#creating-the-image-on-the-openstack-infrastructure" title="Permanent link">&para;</a></h4>
<p>It is first necessary to extract the VM file in VMDK format from the archive generated in the previous step.</p>
<div class="highlight"><pre><span></span><code>$&gt; tar xvzf ubuntu-box.tar.gz box-disk001.vmdk
</code></pre></div>

<p>This is the file that will be used to create the image. You must also specify a name for the image.  </p>
<div class="highlight"><pre><span></span><code>IMAGE_NAME=jupyterhub-image

ostack image create --disk-format vmdk --file box-disk001.vmdk $IMAGE_NAME

ostack image set $IMAGE_NAME

ostack image show $IMAGE_NAME
</code></pre></div>

<h4 id="creating-an-instance-from-the-created-image">Creating an instance from the created image<a class="headerlink" href="#creating-an-instance-from-the-created-image" title="Permanent link">&para;</a></h4>
<p>From the created image, it is now possible to create an instance. You have to specify the name of the instance, its flavor (see above) and the SSH key associated to this VM. The SSH key (keypair) must first have been created from the openstack dashboard.</p>
<p>You can list the SSH keys with the command:</p>
<div class="highlight"><pre><span></span><code>ostack keypair list
</code></pre></div>

<p>You can also specify the file containing the commands to be executed after the first boot. Here this file is necessary (<em>user-data-jupystack.txt</em>) because we must overwrite the file <em>/usr/local/bin/get-hostname</em> giving the complete name of the instance on openstack in order to build the root URL of the jupyterhub application.</p>
<p>In our example, we choose a flavor corresponding to 8 CPUs, 16GB of RAM and 20GB of disk.</p>
<p>An SSH key has been created with the name <em>genostack</em> in the openstack dashboard. This <a href="http://www.genouest.org/outils/genostack/ssh-config.html" target="_blank">SSH key</a> must be a valid key on your (linux) openstack.genouest.org account(file <em>~/.ssh/authorized_keys</em>).</p>
<div class="highlight"><pre><span></span><code>IMAGE_NAME=jupyterhub-image
SERVER_NAME=jupystack
KEYPAIR=genostack
FLAVOR_NAME=m1.xlarge

IMAGEID=$(ostack image show $IMAGE_NAME | \
           grep &quot;| id &quot; | cut -d&#39;|&#39; -f3 | \ 
           sed -e &quot;s/ //g&quot;)
FLAVORID=$(ostack flavor list | \
           grep &quot;$FLAVOR_NAME&quot;  | cut -d&#39;|&#39; -f2 | \
           sed -e &quot;s/ //g&quot;)

onova boot --flavor $FLAVORID --image $IMAGEID --security-groups default \
           --user-data ./user-data-jupystack.txt \
           --key-name $KEYPAIR  $SERVER_NAME

ostack server show $SERVER_NAME
</code></pre></div>

<p>The last command is used to obtain the IP number of the VM thus created. Let's suppose that this IP number is <em>192.168.101.79</em>.  You can then access the application from your web browser at the URL: <em><a href="https://app-192-168-101-79.vm.openstack.genouest.org/hub/login">https://app-192-168-101-79.vm.openstack.genouest.org/hub/login</a></em></p>
<p><br>
<center>
<a href="../images/image5.png" data-lightbox="image5"><img src="../images/image5.png" width="600px"></a>
</center><br><br></p>
<h3 id="acknowledgements">Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permanent link">&para;</a></h3>
<p>We would like to thank the <a href="https://www.genouest.org/2017/03/02/cluster/" target="_blank">IFB GenOuest bioinformatics</a> for providing storage and computing resources on its national life science Cloud.</p>
<p><br><br><br></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../finalvm/" title="Building the Final VM" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Building the Final VM
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Daniel Jacob, INRAE, 2021
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.de50e36d.min.js"></script>
      <script src="../assets/javascripts/bundle.ff925e8b.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../js/lightbox.min.js"></script>
      
        <script src="../js/mermaid.min.js"></script>
      
    
  </body>
</html>