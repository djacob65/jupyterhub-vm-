


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Building automation of a virtual machine (VM) from a server install image of ubuntu (ISO file)">
      
      
      
        <meta name="author" content="Daniel Jacob">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-5.2.2">
    
    
      
        <title>Final VM</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b8fb47b5.min.css">
      
      
    
    
    
    <script src="../js/jquery-2.1.1.min.js"></script>

    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/pdfextra.css">
    
      <link rel="stylesheet" href="../css/lightbox.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#starting-from-an-existing-base-vm-base-box" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-header-nav__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Using JupyterHub within a VM and on the Cloud
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Final VM
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Using JupyterHub within a VM and on the Cloud" class="md-nav__button md-logo" aria-label="Using JupyterHub within a VM and on the Cloud">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Using JupyterHub within a VM and on the Cloud
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Purpose" class="md-nav__link">
      Purpose
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../basebox/" title="Building the Base VM" class="md-nav__link">
      Building the Base VM
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Building the Final VM
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Building the Final VM" class="md-nav__link md-nav__link--active">
      Building the Final VM
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#starting-from-an-existing-base-vm-base-box" class="md-nav__link">
    Starting from an existing base VM (Base box)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-final-vm" class="md-nav__link">
    Building the final VM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#provisioning-using-the-ansible-tool" class="md-nav__link">
    Provisioning using the Ansible tool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shell-script-provisioning" class="md-nav__link">
    Shell script provisioning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-final-vm" class="md-nav__link">
    Creating the final VM
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cloud/" title="Using the Final VM on an Openstack cloud" class="md-nav__link">
      Using the Final VM on an Openstack cloud
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../google-cloud/" title="Using the Final VM on Google Cloud Platform" class="md-nav__link">
      Using the Final VM on Google Cloud Platform
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#starting-from-an-existing-base-vm-base-box" class="md-nav__link">
    Starting from an existing base VM (Base box)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-final-vm" class="md-nav__link">
    Building the final VM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#provisioning-using-the-ansible-tool" class="md-nav__link">
    Provisioning using the Ansible tool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shell-script-provisioning" class="md-nav__link">
    Shell script provisioning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-final-vm" class="md-nav__link">
    Creating the final VM
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Building the Final VM</h1>
                
                <h4 id="starting-from-an-existing-base-vm-base-box">Starting from an existing base VM (Base box)<a class="headerlink" href="#starting-from-an-existing-base-vm-base-box" title="Permanent link">&para;</a></h4>
<p>Creating a base VM can be complex for a non-expert. This is why it is easier to start from a base VM when it is available. This is also why the base VM should be as generic as possible so that it can be easily used for many applications.</p>
<p>The base VM generated and used in this use-case was deposited on <a href="https://app.vagrantup.com/GAEV/boxes/ubuntu1804-dd18Gb" target="_blank">Vagrant Cloud</a>, using its API (see <a href="../basebox/#registering-a-box-on-vagrant-cloud">Registering a box on Vagrant Cloud</a>).</p>
<h4 id="building-the-final-vm">Building the final VM<a class="headerlink" href="#building-the-final-vm" title="Permanent link">&para;</a></h4>
<p>We will use the base VM to provision it, i.e. install and configure all the system and application tools (packages) necessary to make the JupyterHub application work properly. To do this, we will use the Ansible tool as illustrated in the figure below:</p>
<p><br>
<center>
<a href="../images/image2.png" data-lightbox="image2"><img src="../images/image2.png" width="600px"></a>
</center><br><br></p>
<p><strong>Note</strong>: All the scripts and other configuration files mentioned in this description can be found in free access under the <a href="https://github.com/inrae/jupyterhub-vm" target="_blank">GiHub INRAE repository</a>.</p>
<p>The first step is to create a <a href="https://www.vagrantup.com/docs/vagrantfile" target="_blank">Vagrantfile</a> and customise it to suit your needs. This file follows the syntax of the <a href="https://www.ruby-lang.org/fr/about/" target="_blank">Ruby language</a>. A light version is given below:</p>
<div class="highlight"><pre><span></span><code>  Vagrant.configure(&quot;2&quot;) do |config|

    config.vm.box = file://builds/virtualbox-ubuntu1804.box
    config.vm.hostname = jupyterhub

    config.vm.network &quot;private_network&quot;, type: &quot;dhcp&quot;

    config.ssh.insert_key = false

    config.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;, type: &quot;virtualbox&quot;

    config.vm.provision &quot;ansible_local&quot; do |ansible|
        ansible.playbook = &quot;ansible/playbook.yml&quot;
        ansible.install = true
        ansible.limit = &#39;all&#39;
    end

    config.vm.provision &quot;shell&quot;, path: &quot;scripts/cleanup.sh&quot;

  end
</code></pre></div>

<ul>
<li><em>config.vm.box</em><ul>
<li>sets the base box as input</li>
</ul>
</li>
<li><em>config.vm.hostname</em><ul>
<li>defines the hostname of the machine</li>
</ul>
</li>
<li><em>config.vm.network</em><ul>
<li>defines the network configuration in DHCP mode</li>
</ul>
</li>
<li><em>config.ssh.insert_key</em><ul>
<li>defines the SSH key. By default, it will be the one defined in the base box.</li>
</ul>
</li>
<li><em>config.vm.synced_folder</em><ul>
<li>defines a local directory as shared with the VM. At least, the "." directory must be defined in order to configure the VM. These shared directories will only be active during the creation and then test stage before export.</li>
</ul>
</li>
<li><em>config.vm.provision</em><ul>
<li>defines the process by which the VM will be provisioned. Here, two processes are invoked. i) 'ansible_local': indicates that the ansible tool will first be installed on the VM and then use the playbook defined in ansible/playbook; ii) 'shell': indicates that a shell script defined by its relative path will be used.</li>
</ul>
</li>
</ul>
<h4 id="provisioning-using-the-ansible-tool">Provisioning using the Ansible tool<a class="headerlink" href="#provisioning-using-the-ansible-tool" title="Permanent link">&para;</a></h4>
<p>The choice was made not to install Ansible on the host machine used to create the VM, but rather it will be installed on the VM itself, this is to simplify the process.</p>
<p>The provisioning is defined from a <a href="https://en.wikipedia.org/wiki/YAML" target="_blank">YAML</a> file called <a href="https://docs.ansible.com/ansible/2.4/playbooks_intro.html" target="_blank">playbook.yml</a></p>
<div class="highlight"><pre><span></span><code>  ---
- hosts: all
  become: true
  become_user: root
  #gather_facts: no

  vars_files:
    - vars/all.yml

  environment:
    PYTHONHTTPSVERIFY: 0

  roles:
    - repositories
    - server
    - vm
    - install-r
    - jupyterhub
    - r_pkgs
    - python_pkgs
</code></pre></div>

<p>Ansible allows tasks to be organised in a directory structure called a <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html" target="_blank">Role</a>. In this configuration, playbooks invoke roles, which themselves define a set of tasks, so you can always group tasks together and reuse roles in other playbooks. Roles also allow you to collect templates, static files and variables along with your tasks in a structured format. </p>
<p>Each role, and then each task within roles, is interpreted sequentially. Thus the following roles are defined:</p>
<ul>
<li><em>repositories</em><ul>
<li>configures the repositories for binary packages (systems, R, python, tools, ...), </li>
</ul>
</li>
<li><em>server</em><ul>
<li>configure the timezone </li>
</ul>
</li>
<li><em>vm</em><ul>
<li>configure the hostname</li>
</ul>
</li>
<li><em>install-r</em><ul>
<li>installs the R application with basic packages</li>
</ul>
</li>
<li><em>jupyterhub</em><ul>
<li>installs and configures the jupyterhub application</li>
</ul>
</li>
<li><em>r_pkgs</em><ul>
<li>install a set of R packages</li>
</ul>
</li>
<li><em>python_pkgs</em><ul>
<li>install a set of Python packages</li>
</ul>
</li>
</ul>
<p>Each role is defined by a set of tasks, themselves defined by files in YAML format.</p>
<p>For example, the role '<em>repositories</em>' is defined by the following <em>roles/repositories/tasks/main.yml</em> file:</p>
<div class="highlight"><pre><span></span><code>---

- name: Add an apt key by id from a keyserver
  apt_key:
    keyserver: &quot;{{repository.keyserver}}&quot;
    id: &quot;{{repository.id}}&quot;

- name: Add repositories
  apt_repository:
    repo: &quot;{{item}}&quot;
  with_items: &quot;{{repository.repos}}&quot;
</code></pre></div>

<p>Two tasks are thus defined and described by their name field. Then the actual task is defined using a name referring to a <a href="https://docs.ansible.com/ansible/latest/user_guide/modules_intro.html" target="_blank">module</a>. <a href="https://docs.ansible.com/ansible/2.8/modules/list_of_files_modules.html" target="_blank">Hundreds of modules</a> are available in Ansible. Here two modules are invoked:</p>
<ul>
<li><a href="https://docs.ansible.com/ansible/2.8/modules/apt_key_module.html" target="_blank">apt_key</a>: add or remove an apt key</li>
<li><a href="https://docs.ansible.com/ansible/2.8/modules/apt_repository_module.html" target="_blank">apt_repository</a>: add or remove a binary package repository. The <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html" target="_blank">variables</a>  defined by the double braces {{ }} correspond to those defined in the <em>vars/all.yml</em> file itself declared in the playbook. Thus the following lines can be found in this file:</li>
</ul>
<div class="highlight"><pre><span></span><code>repository:
    keyserver: hkp://keyserver.ubuntu.com:80
    id: E298A3A825C0D65DFD57CBB651716619E084DAB9
    repos:
      - ppa:c2d4u.team/c2d4u4.0+
      - ppa:hnakamur/libgit2
      - deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran40/
</code></pre></div>

<p>So this is how the provisioning task set is defined by Ansible. </p>
<p>The '<em>jupyterhub</em>' role was built from the instructions provided on the <a href="https://tljh.jupyter.org/en/latest/" target="_blank">TLJH</a> website. The list of Python and R packages needed for a specific use under JupyterHub are to be defined in the <em>vars/all.yml file</em>, whose installation is taken care of by the '<em>python_pkgs</em>' and '<em>r_pkgs</em>' roles respectively.</p>
<h4 id="shell-script-provisioning">Shell script provisioning<a class="headerlink" href="#shell-script-provisioning" title="Permanent link">&para;</a></h4>
<p>Once the provisioning by Ansible is finished, we proceed to a VM cleanup, i.e. uninstall Ansible, clean the temporary files and clean the hard disk. We use a Shell script (<em>scripts/cleanup.sh</em>) for this.</p>
<h4 id="creating-the-final-vm">Creating the final VM<a class="headerlink" href="#creating-the-final-vm" title="Permanent link">&para;</a></h4>
<p>Once the configuration is established, you just have to execute the following commands:</p>
<div class="highlight"><pre><span></span><code>$&gt; vagrant up
$&gt; vagrant package --output ubuntu-box.tar.gz
</code></pre></div>

<p>All the messages produced can be consulted on the <a href="https://github.com/inrae/jupyterhub-vm/blob/master/logs/vagrant.log" target="_blank">github repository</a></p>
<p><br><br><br></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../basebox/" title="Building the Base VM" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Building the Base VM
              </div>
            </div>
          </a>
        
        
          <a href="../cloud/" title="Using the Final VM on an Openstack cloud" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Using the Final VM on an Openstack cloud
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Daniel Jacob, INRAE, 2021
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.de50e36d.min.js"></script>
      <script src="../assets/javascripts/bundle.ff925e8b.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../js/lightbox.min.js"></script>
      
        <script src="../js/mermaid.min.js"></script>
      
    
  </body>
</html>